<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title>Cart</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="google-signin-client_id" content="1082298468320-93vqqs6ngqpg7h2vkojdhdas0ir3jt8p.apps.googleusercontent.com">

	<!-- Sweet alert2-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>

	<script src="https://apis.google.com/js/platform.js" async defer></script>
<!--===============================================================================================-->
	<link rel="icon" type="image/png" th:href="@{/public/images/icons/favicon.png}"/>
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/vendor/bootstrap/css/bootstrap.min.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/fonts/font-awesome-4.7.0/css/font-awesome.min.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/fonts/themify/themify-icons.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/fonts/Linearicons-Free-v1.0.0/icon-font.min.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/fonts/elegant-font/html-css/style.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/vendor/animate/animate.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/vendor/css-hamburgers/hamburgers.min.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/vendor/animsition/css/animsition.min.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/vendor/select2/select2.min.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/vendor/slick/slick.css}">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" th:href="@{/public/stylesheets/util.css}">
	<link rel="stylesheet" type="text/css" th:href="@{/public/stylesheets/main.css}">
</head>
<body class="animsition">
	
	<!-- Header -->
	<header class="header1">
		<!-- Header desktop -->
		<div class="container-menu-header">
			<div class="topbar">
				<div class="topbar-social">
					<a href="https://www.facebook.com/Dc.Koool" class="topbar-social-item fa fa-facebook"></a>
					<a href="https://www.instagram.com/dckoool/" class="topbar-social-item fa fa-instagram"></a>
					<a href="https://www.pinterest.com/" class="topbar-social-item fa fa-pinterest-p"></a>
					<a href="https://www.youtube.com/" class="topbar-social-item fa fa-youtube-play"></a>
				</div>

				<span class="topbar-child1" id="testttt">
					Miễn phí vận chuyển với đơn hàng trên 500k
				</span>

				<div class="topbar-child2">
					<span class="topbar-email">
						support@cccstore.tk
					</span>
				</div>
			</div>

			<div class="wrap_header">
				<!-- Logo -->
				<a th:href="@{/}" class="logo">
					<img th:src="@{/public/images/icons/lg.png}" alt="IMG-LOGO">
				</a>

				<!-- Menu -->
				<div class="wrap_menu">
					<nav class="menu">
						<ul class="main_menu">
							<li>
								<a th:href="@{/}">Trang chủ</a>
							</li>

							<li style="text-shadow: 1px 1px grey">
								<a href="cart">Giỏ hàng</a>
							</li>

							<li>
								<a href="https://www.facebook.com/">Liên hệ</a>
							</li>
						</ul>
					</nav>
				</div>

				<!-- Header Icon -->
				<div class="header-icons">

					<div hidden="" id="thongtinKH" class="header-wrapicon2">
						<img th:src="@{/public/images/icons/icon-header-01.png}" class="header-icon1 js-show-header-dropdown" alt="ICON">
						<!-- Header cart noti -->
						<div class="header-cart header-dropdown">
							<ul class="header-cart-wrapitem">
								<li class="header-cart-item">
									<div class="header-cart-item-txt">
										<a id="tenKH" class="header-cart-item-name font-weight-bold text-danger" th:text="${user.userName}">
											Nguyễn Văn Mạnh Cường
										</a>
									</div>
								</li>

								<li class="header-cart-item">
									<div class="header-cart-item-txt">
										<a id="emailKH" class="header-cart-item-name" th:text="${user.email}">
											cuongfpi1313131@gmail.com
										</a>
									</div>
								</li>
								<li class="header-cart-item">
									<div class="header-cart-item-txt">
										<a id="sdtKH" class="header-cart-item-name" th:text="${user.phone}">
											0987767216
										</a>
									</div>
								</li>
							</ul>

							<div class="header-cart-buttons">
								<div class="header-cart-wrapbtn">
									<!-- Button -->
									<a href="logout" class="flex-c-m size1 bg1 bo-rad-15 hov1 s-text1 trans-0-4">
										<button style="color:white" >Đăng xuất</button>
									</a>
								</div>

							</div>
						</div>
					</div>

					<button id="btndangnhap" class="header-wrapicon1 dis-block">
						<a href="Login">
							<img th:src="@{/public/images/icons/icon-header-01.png}" class="header-icon1" alt="ICON">
						</a>
					</button>

					<span class="linedivide1"></span>

					<div class="header-wrapicon2">
						<a href="cart"><img th:src="@{/public/images/icons/icon-header-02.png}" class="header-icon1 js-show-header-dropdown" alt="ICON"></a>
						<span class="header-icons-noti" id="cart-noti" th:text="${quantity}"></span>
					</div>
				</div>
			</div>
		</div>

	</header>

	<!-- Title Page -->
	<section class="bg-title-page p-t-40 p-b-50 flex-col-c-m" th:style="'background-image: url(public/images/banner1.jpg)'">
		<h2 class="l-text2 t-center">
			Giỏ hàng của bạn
		</h2>
	</section>

	<!-- Cart -->
	<section class="cart bgwhite p-t-70 p-b-100">
		<div class="container">
			<!-- Cart item -->
			<div class="container-table-cart pos-relative">
				<div class="wrap-table-shopping-cart bgwhite">
					<table class="table-shopping-cart">
						<tr class="table-head">

							<th class="column-1">Hình</th>
							<th class="column-2">Sản phẩm</th>
							<th class="column-3">Giá</th>
							<th class="column-4 p-l-70">Số lượng</th>
							<th class="column-5">Thành tiền</th>
						</tr>
						<!--item trong giỏi hàng-->
						<tr class="table-row" id="rowstart" th:each="item : ${dsCart}">
							<td type="text" id="idpro" th:text="${item.product.idPro}" hidden="true"></td>
							<td class="column-1" >
								<div class="cart-img-product b-rad-4 o-f-hidden">
									<img class="imge" id="imgSp" th:src="@{${item.product.urlImage}}" alt="IMG-PRODUCT">
								</div>
							</td>
							<td class="column-2" id="nameSp" th:value="${item.product.namePro}" th:text="${item.product.namePro}"></td>
							<td class="column-3 priceSP" th:text="${item.product.price}">
							</td>
							<td class="column-4 p-l-70">
								<div class="flex-w bo5 of-hidden w-size17">
									<button class="btn-num-product-down color1 flex-c-m size7 bg8 eff2">
										<i class="fs-12 fa fa-minus" aria-hidden="true"></i>
									</button>
									<input id="sl_sp_1" class="size8 m-text18 t-center num-product" type="number" name="num-product2" th:value="${item.quantity}">

									<button class="btn-num-product-up color1 flex-c-m size7 bg8 eff2">
										<i class="fs-12 fa fa-plus" aria-hidden="true"></i>
									</button>
								</div>
							</td>
							<td id="thanhTien" class="column-5"></td>
							<td id="btn-delete" class="column-6 btn-light" style="text-align: center;">Xóa</td>
							<td id="priceSp" class="column-7" hidden="true" th:value="${item.product.price}" th:text="${item.product.price}"></td>
						</tr>
					</table>
				</div>
			</div>
			<!-- Total -->
			<div class="bo9 w-size18 p-l-40 p-r-40 p-t-30 p-b-38 m-t-30 m-r-0 m-l-auto p-lr-15-sm">
				<h5 class="m-text20 p-b-24">
					Mua
				</h5>

				<!--  -->
				<div class="flex-w flex-sb-m p-b-12">
					<span class="s-text18 w-size19 w-full-sm">
						Tổng tiền:
					</span>

					<span class="m-text25 w-size20 w-full-sm" id="totalPrice" th:text="${totalPrice}">
					</span>
				</div>

				<div class="size15 trans-0-4">
					<!-- Button -->
					<a id="thanhtoan">
						<button class="flex-c-m sizefull bg1 bo-rad-23 hov1 s-text1 trans-0-4 pay" id="btn_dathang">
							Tiến hành đặt hàng
						</button>
					</a>
				</div>
			</div>
		</div>
	</section>

	<!-- Footer -->
	<footer class="bg6 p-t-10 p-b-10 p-l-10 p-r-10">
		<div class="t-center p-l-15 p-r-15">
			<div class="t-center s-text8 p-t-20">
				Copyright © 2018 All rights reserved. | From CCC with <i class="fa fa-heart-o" aria-hidden="true"></i>
			</div>
		</div>
        <p id="isLogin" th:text="${isLogin}" hidden>0</p>
        <p id="slsp" hidden>0</p>
	</footer>

	<!-- Back to top -->
	<div class="btn-back-to-top bg0-hov" id="myBtn">
		<span class="symbol-btn-back-to-top">
			<i class="fa fa-angle-double-up" aria-hidden="true"></i>
		</span>
	</div>

	<!-- Container Selection -->
	<div id="dropDownSelect1"></div>
	<div id="dropDownSelect2"></div>

<!--===============================================================================================-->
	<script type="text/javascript" th:src="@{/public/vendor/jquery/jquery-3.2.1.min.js}"></script>
<!--===============================================================================================-->
	<script type="text/javascript" th:src="@{/public/vendor/animsition/js/animsition.min.js}"></script>
<!--===============================================================================================-->
	<script type="text/javascript" th:src="@{/public/vendor/bootstrap/js/popper.js}"></script>
	<script type="text/javascript" th:src="@{/public/vendor/bootstrap/js/bootstrap.min.js}"></script>
<!--===============================================================================================-->
	<script type="text/javascript" th:src="@{/public/vendor/select2/select2.min.js}"></script>
	<script type="text/javascript">
		
		if($("#isLogin").text()=="ok"){
			$("#thongtinKH").removeAttr('hidden');
			$("#btndangnhap").attr('hidden', 'true');
		}else {
			$("#btndangnhap").removeAttr('hidden');
			$("#thongtinKH").attr('hidden', 'true');
		}

		//Format tiền 
        function formatNumber(num) {
		  return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')+" $"
		}

		function upTotalPrice(p) {
			var price =0;
			$('#rowstart td#priceSp').each(function() {

				price += Number($(this).text())*Math.round($(this).parent().find('#sl_sp_1').val());
			});
			price += Number(p);
		  	var f = formatNumber(price);
			$("#totalPrice").text(f);
		}

		function downTotalPrice(p) {
			var price =0;
			$('#rowstart td#priceSp').each(function() {

				price += Number($(this).text())*Math.round($(this).parent().find('#sl_sp_1').val());
			});
			price -= Number(p);
		  	var f = formatNumber(price);
			$("#totalPrice").text(f);
		}

		$(".selection-1").select2({
			minimumResultsForSearch: 20,
			dropdownParent: $('#dropDownSelect1')
		});

		$(".selection-2").select2({
			minimumResultsForSearch: 20,
			dropdownParent: $('#dropDownSelect2')
		});

		$(function () {
			var price = Math.round($("#totalPrice").text());
			var f = formatNumber(price);
			$("#totalPrice").text(f);
		});
		

	</script>
	<script type="text/javascript">
		
		//Format giá từng item
        $('#rowstart td.priceSP').each(function() {		
			var price = Math.round($(this).html());
			var f = formatNumber(price);
			$(this).text(f);						
		});
		
		//Format giá thành tiền
        $('#rowstart td#thanhTien').each(function() {		
			var price = Math.round($(this).parent().find('#priceSp').text());
			var sl =  Math.round($(this).parent().find('#sl_sp_1').val());
			var tong = price*sl;
			var f = formatNumber(tong);
			$(this).text(f);						
		});

		$('.cart-img-product').each(function() {			
			$(this).on('click',function () {
				/* Act on the event */
				var key = $(this).parent().parent().find('#idpro').text();
                Swal.fire({
				  title: 'Are you sure?',
				  text: "You won't be able to revert this!",
				  type: 'warning',
				  showCancelButton: true,
				  confirmButtonColor: '#3085d6',
				  cancelButtonColor: '#d33',
				  confirmButtonText: 'Yes, delete it!'
				}).then((result) => {
				  if (result.value) {
				     $.ajax({
			            url: '/webBH/deleteCart',
			            type: 'post',
			            dataType: 'html',
			            data: {
				            key:key
			            },
			            success: function(data){
				        	Swal.fire(
				              'Items has deleted!',
				              '',
				              'success'
				            ).then((result) =>{
				              location.reload();
				            });
			        	}
			        });
				  }
				})
			});
		});
		//nút tăng số lượng
        $('.btn-num-product-up').each(function(){
                $(this).on('click',function () {
                    var key = $(this).parent().parent().parent().find('#idpro').text();
                    var price = Math.round($(this).parent().parent().parent().find('#priceSp').text());
					var sl =  Math.round($(this).parent().parent().find('#sl_sp_1').val())+1;
					var tong = price*sl;
					var f = formatNumber(tong);
					$(this).parent().parent().parent().find('#thanhTien').text(f);
                    $.ajax({
			            url: '/webBH/upQuantity',
			            type: 'post',
			            dataType: 'html',
			            data: {
				            key:key
			            },
			            success: function(data){
			        	}
			        })

			        upTotalPrice(price);
                })
        });

         //nút giảm số lượng
        $('.btn-num-product-down').each(function(){
            $(this).on('click',function () {
            	var s = Math.round($(this).parent().parent().find('#sl_sp_1').val());
            	if(s>1){
            		var key = $(this).parent().parent().parent().find('#idpro').text();
                    var price = Math.round($(this).parent().parent().parent().find('#priceSp').text());
					var sl =  Math.round($(this).parent().parent().find('#sl_sp_1').val())-1;
					var tong = price*sl;
					var f = formatNumber(tong);
					$(this).parent().parent().parent().find('#thanhTien').text(f);
                    $.ajax({
			            url: '/webBH/downQuantity',
			            type: 'post',
			            dataType: 'html',
			            data: {
				            key:key
			            },
			            success: function(data){
			        	}
			        })

			        downTotalPrice(price);
            	}else{
            		var key = $(this).parent().parent().parent().find('#idpro').text();
            		Swal.fire({
					  title: 'Are you sure?',
					  text: "You won't be able to revert this!",
					  type: 'warning',
					  showCancelButton: true,
					  confirmButtonColor: '#3085d6',
					  cancelButtonColor: '#d33',
					  confirmButtonText: 'Yes, delete it!'
					}).then((result) => {
					  if (result.value) {
					     $.ajax({
				            url: '/webBH/deleteCart',
				            type: 'post',
				            dataType: 'html',
				            data: {
					            key:key
				            },
				            success: function(data){
					        	Swal.fire(
					              'Items has deleted!',
					              '',
					              'success'
					            ).then((result) =>{
					              location.reload();
					            });
				        	}
				        });
					  }
					})
            	}   	
            })
        });

        //nút xóa item trong giỏ
        $('.btn-light').each(function(){
            $(this).on('click',function () {
                var key = $(this).parent().find('#idpro').text();
                Swal.fire({
				  title: 'Are you sure?',
				  text: "You won't be able to revert this!",
				  type: 'warning',
				  showCancelButton: true,
				  confirmButtonColor: '#3085d6',
				  cancelButtonColor: '#d33',
				  confirmButtonText: 'Yes, delete it!'
				}).then((result) => {
				  if (result.value) {
				     $.ajax({
			            url: '/webBH/deleteCart',
			            type: 'post',
			            dataType: 'html',
			            data: {
				            key:key
			            },
			            success: function(data){
				        	Swal.fire(
				              'Items has deleted!',
				              '',
				              'success'
				            ).then((result) =>{
				              location.reload();
				            });
			        	}
			        });
				  }
				})
            })
        });
  		

  		//Nút đặt hàng
  		$("#btn_dathang").click(function(event) {
  			/* Act on the event */
  			var isLogin = $("#isLogin").text();
  			if(isLogin  != "ok"){
  				Swal.fire({
				  title: 'Bạn phải đăng nhập để đặt hàng!',
				  type: 'warning',
				  confirmButtonText:  'Ok!',
				  cancelButtonText:  'Canel',
				  showCancelButton: true,
				  showCloseButton: true
				}).then((result) => {
					if (result.value) {
						window.location.href='/webBH/Login';
					}
				})
  			}else{
  				Swal.fire({
				  title: 'Are you sure?',
				  text: "Bạn muốn đặt những món hàng này?",
				  type: 'question',
				  showCancelButton: true,
				  confirmButtonText: 'Yes!',
				  cancelButtonText: 'No, cancel!'
				}).then((result) => {
					var postData = [];
	  				var totalPrice = 0;
	  				var userName = $("#tenKH").text();  				
	  				$(".table-row").each(function() {
	  					var obj = {};
	  					var idPro = $(this).find('#idpro').text();
	  					var quantity = $(this).find('#sl_sp_1').val();
	  					var price = Number($(this).find('#priceSp').text());
	  					obj.idPro = idPro;
	  					obj.quantity = quantity;
	  					obj.price =price;
	  					postData.push(obj);
	  					totalPrice += ( (Number(quantity)) * (Number(price)) );
	  				});
	  				$.ajax({
		                url: '/webBH/datHang',
		                type: 'post',
		                dataType: 'html',
		                data: {
		                    dsSp:JSON.stringify(postData),
		                    totalPrice:totalPrice,
		                    userName:userName

		                },
		                success: function(data){
					     	Swal.fire(
					        	  'Đặt hàng thành công!',
					        	  '',
					        	  'success'
					        ).then((result) => {
								if (result.value) {
									window.location.href='/webBH/';
								}
							})
				        }
		            });
					
				})
  				
  			}
  		});
    </script>
<!--===============================================================================================-->
	<script th:src="@{/public/javascripts/main.js}"></script>
</body>
</html>
